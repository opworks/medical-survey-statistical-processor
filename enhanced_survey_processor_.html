<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vascular Trauma Survey Analysis Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-style: italic;
        }
        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px dashed #dee2e6;
            text-align: center;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 15px 0;
        }
        #fileInput {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-label {
            display: inline-block;
            padding: 12px 25px;
            background: #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-input-label:hover {
            background: #2980b9;
        }
        button {
            padding: 15px 30px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: block;
            margin: 20px auto;
            min-width: 200px;
        }
        button:hover:not(:disabled) {
            background: linear-gradient(45deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        .feature-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .preview-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .data-preview {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üè• Vascular Trauma Survey Analysis Generator</h1>
        <p class="subtitle">Transform raw survey data into analysis-ready Excel workbook with statistical tools</p>
        
        <div class="upload-section">
            <h3>üìÅ Upload Survey Data</h3>
            <p>Select your raw Excel file containing vascular trauma survey responses</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
                <label for="fileInput" class="file-input-label">Choose Excel File</label>
            </div>
            <div id="fileName" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <button id="generateButton" disabled>üöÄ Generate Analysis Workbook</button>
        
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>

        <div class="features">
            <div class="feature-card">
                <div class="feature-title">üìä Data Transformation</div>
                <div>‚Ä¢ Converts Likert scales to numerical values (1-5)<br>
                ‚Ä¢ Standardizes time responses to minutes<br>
                ‚Ä¢ Creates binary indicators for analysis<br>
                ‚Ä¢ Handles missing data systematically</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">üìà Analysis Templates</div>
                <div>‚Ä¢ Pre-built pivot table templates<br>
                ‚Ä¢ Odds ratio calculation formulas<br>
                ‚Ä¢ Correlation matrix setup<br>
                ‚Ä¢ Statistical summary tables</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">üìã Ready-to-Use Outputs</div>
                <div>‚Ä¢ Clean flat data table<br>
                ‚Ä¢ Analysis instruction sheet<br>
                ‚Ä¢ Variable dictionary<br>
                ‚Ä¢ Dashboard template</div>
            </div>
        </div>

        <div class="preview-section" id="previewSection">
            <h3>üìã Data Preview</h3>
            <div class="data-preview" id="dataPreview"></div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const generateButton = document.getElementById('generateButton');
        const status = document.getElementById('status');
        const fileName = document.getElementById('fileName');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const previewSection = document.getElementById('previewSection');
        const dataPreview = document.getElementById('dataPreview');

        let rawData = null;

        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }

        function showStatus(message, type = 'processing') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        fileInput.addEventListener('change', async () => {
            if (fileInput.files.length) {
                const file = fileInput.files[0];
                fileName.textContent = `Selected: ${file.name}`;
                generateButton.disabled = false;
                
                // Show preview
                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    rawData = XLSX.utils.sheet_to_json(worksheet);
                    
                    const finishedCount = rawData.filter(row => row['Finished'] === true || row['Finished'] === 'TRUE').length;
                    dataPreview.textContent = `Total responses: ${rawData.length}\nCompleted responses: ${finishedCount}\nColumns: ${Object.keys(rawData[0] || {}).length}`;
                    previewSection.style.display = 'block';
                } catch (error) {
                    showStatus('Error reading file preview', 'error');
                }
            } else {
                generateButton.disabled = true;
                fileName.textContent = '';
                previewSection.style.display = 'none';
            }
        });

        // Enhanced scalar and time mappings
        const scalarMaps = {
            Satisfaction: {
                'Extremely satisfied': 5,
                'Somewhat satisfied': 4,
                'Neither satisfied nor dissatisfied': 3,
                'Somewhat dissatisfied': 2,
                'Extremely dissatisfied': 1,
                'No Response': null
            },
            CallCoverageProblem: {
                'Not a problem': 5,
                'Minor problem': 4,
                'Adequate': 3,
                'Significant problem': 2,
                'Above average': 1,
                'No Response': null
            },
            Comfort: {
                'Strongly agree': 5,
                'Somewhat agree': 4,
                'Neither agree nor disagree': 3,
                'Somewhat disagree': 2,
                'Strongly disagree': 1,
                'No Response': null
            },
            CompensationLevel: {
                'Excellent': 5,
                'Very good': 4,
                'Good': 3,
                'Fair': 2,
                'Poor': 1,
                'No Response': null
            }
        };

        const timeMaps = {
            'Less than 30 minutes': 15,
            '30‚Äì60 minutes': 45,
            '1‚Äì2 hours': 90,
            '2‚Äì3 hours': 150,
            '3+ hours': 240,
            'Not applicable': null,
            'No Response': null
        };

        generateButton.addEventListener('click', async () => {
            generateButton.disabled = true;
            progressBar.style.display = 'block';
            showStatus('Processing survey data...', 'processing');
            updateProgress(10);

            try {
                const file = fileInput.files[0];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                updateProgress(25);

                showStatus('Filtering and transforming data...', 'processing');
                
                // Filter for completed responses only
                const filteredData = rawData.filter(row => row['Finished'] === true || row['Finished'] === 'TRUE');
                updateProgress(40);

                // Create enhanced flat table with all analysis variables
                const flatTable = filteredData.map((row, index) => {
                    // Multi-select Q3 - Vascular Coverage
                    const vascularCoverage = [
                        row['Q3_1'] ? 'Affiliated residency program' : '',
                        row['Q3_2'] ? 'Vascular surgeons on staff' : '',
                        row['Q3_3'] ? 'Outside private practice' : '',
                        row['Q3_4'] ? 'No coverage' : '',
                        row['Q3_5'] ? 'Other' : ''
                    ].filter(v => v).join(';') || 'No Response';

                    // Multi-select Q6 - Compensated Activities
                    const compensatedActivities = [
                        row['Q6_1'] ? 'Phone consultation' : '',
                        row['Q6_2'] ? 'In-person consultation' : '',
                        row['Q6_3'] ? 'Procedural activity' : '',
                        row['Q6_4'] ? 'Other' : ''
                    ].filter(v => v).join(';') || 'No Response';

                    // Extract transfer distance from text fields
                    const transferDistanceText = String(row['Q12_2_TEXT'] || row['Q12_3_TEXT'] || '');
                    const transferDistance = parseFloat(transferDistanceText.match(/\d+(\.\d+)?/)?.[0]) || null;

                    // Combine comments
                    const comments = [row['Q20'] || '', row['Q22'] || ''].filter(v => v).join('; ') || 'No Response';

                    return {
                        // Core identifiers
                        ResponseId: row['ResponseId'] || `RESP_${index + 1}`,
                        FacilityId: row['FacilityID'] || 'Unknown',
                        TraumaCenterLevel: row['TC Level'] || row['Merged.1'] || 'Unknown',
                        Finished: row['Finished'] ? 1 : 0,
                        
                        // Primary analysis variables (original + scalar)
                        Q3_VascularCoverage: vascularCoverage,
                        Q4_CallCoverage: row['Q4'] || 'No Response',
                        Q5_CompensationType: row['Q5'] || 'No Response',
                        Q6_CompensatedActivities: compensatedActivities,
                        Q7_CompensationLevel: row['Q7'] || 'No Response',
                        Q7_CompensationLevel_Scalar: scalarMaps.CompensationLevel[row['Q7']] ?? null,
                        Q8_StaffCallRequirement: row['Q8'] || 'No Response',
                        Q9_CallCoverageProblem: row['Q9'] || 'No Response',
                        Q9_CallCoverageProblem_Scalar: scalarMaps.CallCoverageProblem[row['Q9']] ?? null,
                        Q10_ResponseTime: row['Q10'] || 'No Response',
                        Q10_ResponseTime_Minutes: timeMaps[row['Q10']] ?? null,
                        Q11_TransferTime: row['Q11'] || 'No Response',
                        Q11_TransferTime_Minutes: timeMaps[row['Q11']] ?? null,
                        Q12_EquipmentAvailability: row['Q12'] || 'No Response',
                        Q12_TransferDistance: transferDistance,
                        Q13_EvalComfort: row['Q13'] || 'No Response',
                        Q13_EvalComfort_Scalar: scalarMaps.Comfort[row['Q13']] ?? null,
                        Q14_ManageComfort: row['Q14'] || 'No Response',
                        Q14_ManageComfort_Scalar: scalarMaps.Comfort[row['Q14']] ?? null,
                        Q15_Satisfaction: row['Q15'] || 'No Response',
                        Q15_Satisfaction_Scalar: scalarMaps.Satisfaction[row['Q15']] ?? null,
                        
                        // Telehealth variables
                        Q16_TelehealthAvailability: row['Q16'] || 'No Response',
                        Q17_TelehealthFrequency: row['Q17'] || 'No Response',
                        Q18_TelehealthAnticipation: row['Q18'] || 'No Response',
                        Q19_TelehealthLevel: row['Q19'] || 'No Response',
                        
                        // Additional variables
                        Q21_Recommendation: row['Q21'] || 'No Response',
                        Comments: comments,
                        
                        // Binary indicators for analysis
                        VascularCoverage_Residency: row['Q3_1'] ? 1 : 0,
                        VascularCoverage_Staff: row['Q3_2'] ? 1 : 0,
                        VascularCoverage_Private: row['Q3_3'] ? 1 : 0,
                        VascularCoverage_None: row['Q3_4'] ? 1 : 0,
                        VascularCoverage_Other: row['Q3_5'] ? 1 : 0,
                        CompensatedActivity_Phone: row['Q6_1'] ? 1 : 0,
                        CompensatedActivity_InPerson: row['Q6_2'] ? 1 : 0,
                        CompensatedActivity_Procedural: row['Q6_3'] ? 1 : 0,
                        CompensatedActivity_Other: row['Q6_4'] ? 1 : 0,
                        HasTelehealth: row['Q16'] === 'Yes' ? 1 : 0,
                        
                        // Analytical groupings
                        VascularCoverage_StaffOnly: (row['Q3_2'] && !row['Q3_1'] && !row['Q3_3'] && !row['Q3_4'] && !row['Q3_5']) ? 1 : 0,
                        VascularCoverage_OutsideOnly: (row['Q3_3'] && !row['Q3_1'] && !row['Q3_2'] && !row['Q3_4'] && !row['Q3_5']) ? 1 : 0,
                        HighSatisfaction: (scalarMaps.Satisfaction[row['Q15']] >= 4) ? 1 : 0,
                        LowSatisfaction: (scalarMaps.Satisfaction[row['Q15']] <= 2) ? 1 : 0,
                        AdequateCoverage: (scalarMaps.CallCoverageProblem[row['Q9']] >= 4) ? 1 : 0,
                        HighComfort_Eval: (scalarMaps.Comfort[row['Q13']] >= 4) ? 1 : 0,
                        HighComfort_Manage: (scalarMaps.Comfort[row['Q14']] >= 4) ? 1 : 0,
                        FastResponse: (timeMaps[row['Q10']] <= 45) ? 1 : 0,
                        SlowResponse: (timeMaps[row['Q10']] >= 150) ? 1 : 0
                    };
                });
                updateProgress(60);

                showStatus('Creating analysis workbook...', 'processing');

                // Create new workbook with multiple sheets
                const newWb = XLSX.utils.book_new();

                // 1. Flat data sheet
                const flatWs = XLSX.utils.json_to_sheet(flatTable);
                XLSX.utils.book_append_sheet(newWb, flatWs, 'Survey_Data');
                updateProgress(70);

                // 2. Variable Dictionary
                const variableDict = [
                    ['Variable', 'Description', 'Type', 'Values/Range'],
                    ['ResponseId', 'Unique response identifier', 'Text', 'Unique ID'],
                    ['FacilityId', 'Facility identifier', 'Text', 'Various'],
                    ['TraumaCenterLevel', 'Trauma center designation', 'Categorical', 'Level 1, 2, 3'],
                    ['Q15_Satisfaction_Scalar', 'PRIMARY OUTCOME: Satisfaction with vascular coverage', 'Ordinal', '1-5 (1=Extremely dissatisfied, 5=Extremely satisfied)'],
                    ['Q9_CallCoverageProblem_Scalar', 'ALTERNATIVE OUTCOME: Coverage adequacy', 'Ordinal', '1-5 (1=Above average, 5=Not a problem)'],
                    ['Q4_CallCoverage', 'Call coverage model', 'Categorical', 'Various coverage types'],
                    ['Q5_CompensationType', 'Compensation type', 'Categorical', 'Various compensation models'],
                    ['Q7_CompensationLevel_Scalar', 'Compensation level satisfaction', 'Ordinal', '1-5 (1=Poor, 5=Excellent)'],
                    ['Q13_EvalComfort_Scalar', 'Comfort evaluating vascular trauma', 'Ordinal', '1-5 (1=Strongly disagree, 5=Strongly agree)'],  
                    ['Q14_ManageComfort_Scalar', 'Comfort managing vascular trauma', 'Ordinal', '1-5 (1=Strongly disagree, 5=Strongly agree)'],
                    ['Q10_ResponseTime_Minutes', 'Response time in minutes', 'Continuous', 'Midpoint values (15, 45, 90, 150, 240)'],
                    ['Q11_TransferTime_Minutes', 'Transfer time in minutes', 'Continuous', 'Midpoint values (15, 45, 90, 150, 240)'],
                    ['HasTelehealth', 'Telehealth availability', 'Binary', '0=No, 1=Yes'],
                    ['VascularCoverage_Staff', 'Staff surgeons provide coverage', 'Binary', '0=No, 1=Yes'],
                    ['VascularCoverage_Private', 'Private practice provides coverage', 'Binary', '0=No, 1=Yes'],
                    ['HighSatisfaction', 'High satisfaction (4-5 on scale)', 'Binary', '0=No, 1=Yes'],
                    ['LowSatisfaction', 'Low satisfaction (1-2 on scale)', 'Binary', '0=No, 1=Yes'],
                    ['AdequateCoverage', 'Adequate coverage (4-5 on Q9)', 'Binary', '0=No, 1=Yes'],
                    ['FastResponse', 'Fast response (‚â§45 min)', 'Binary', '0=No, 1=Yes'],
                    ['SlowResponse', 'Slow response (‚â•150 min)', 'Binary', '0=No, 1=Yes']
                ];
                const dictWs = XLSX.utils.aoa_to_sheet(variableDict);
                XLSX.utils.book_append_sheet(newWb, dictWs, 'Variable_Dictionary');

                // 3. Analysis Templates Sheet
                const analysisTemplate = [
                    ['VASCULAR TRAUMA SURVEY - STATISTICAL ANALYSIS TEMPLATES'],
                    [''],
                    ['=== UNIVARIATE ANALYSIS FRAMEWORK ==='],
                    ['Primary Outcome: Q15_Satisfaction_Scalar (1-5)'],
                    ['Alternative Outcome: Q9_CallCoverageProblem_Scalar (1-5)'],
                    [''],
                    ['Key Predictors to Test:'],
                    ['‚Ä¢ Q4_CallCoverage (Categorical)'],
                    ['‚Ä¢ Q5_CompensationType (Categorical)'],
                    ['‚Ä¢ Q7_CompensationLevel_Scalar (Ordinal 1-5)'],
                    ['‚Ä¢ Q13_EvalComfort_Scalar (Continuous 1-5)'],
                    ['‚Ä¢ Q14_ManageComfort_Scalar (Continuous 1-5)'],
                    ['‚Ä¢ Q10_ResponseTime_Minutes (Continuous)'],
                    ['‚Ä¢ Q11_TransferTime_Minutes (Continuous)'],
                    ['‚Ä¢ HasTelehealth (Binary 0/1)'],
                    ['‚Ä¢ VascularCoverage_Staff (Binary 0/1)'],
                    [''],
                    ['=== STRATIFICATION VARIABLES ==='],
                    ['‚Ä¢ TraumaCenterLevel (Level 1, 2, 3)'],
                    ['‚Ä¢ VascularCoverage type (Q3 combinations)'],
                    ['‚Ä¢ HasTelehealth (Yes/No)'],
                    [''],
                    ['=== EXCEL ANALYSIS INSTRUCTIONS ==='],
                    ['1. PIVOT TABLES: Insert > PivotTable using Survey_Data'],
                    ['   - Rows: TraumaCenterLevel, Q4_CallCoverage'],
                    ['   - Values: Count of Q15_Satisfaction_Scalar, Average of Q15_Satisfaction_Scalar'],
                    [''],
                    ['2. ODDS RATIOS: Create 2x2 tables using COUNTIFS'],
                    ['   Example for Telehealth vs High Satisfaction:'],
                    ['   =COUNTIFS(Survey_Data[HasTelehealth],1,Survey_Data[HighSatisfaction],1)'],
                    [''],
                    ['3. CORRELATION MATRIX: Use CORREL function'],
                    ['   =CORREL(Survey_Data[Q13_EvalComfort_Scalar],Survey_Data[Q15_Satisfaction_Scalar])'],
                    [''],
                    ['4. CHARTS: Insert > Charts'],
                    ['   - Bar charts for categorical variables'],
                    ['   - Scatter plots for continuous variables'],
                    ['   - Stacked bars for stratified analysis'],
                    [''],
                    ['5. STATISTICAL TESTS: Use built-in functions'],
                    ['   - T.TEST for group comparisons'],
                    ['   - CHISQ.TEST for categorical associations'],
                    ['   - CONFIDENCE.NORM for confidence intervals']
                ];
                const templateWs = XLSX.utils.aoa_to_sheet(analysisTemplate);
                XLSX.utils.book_append_sheet(newWb, templateWs, 'Analysis_Instructions');
                updateProgress(80);

                // 4. Summary Statistics Sheet
                const totalResponses = flatTable.length;
                const summaryStats = [
                    ['SURVEY RESPONSE SUMMARY'],
                    [''],
                    ['Total Completed Responses:', totalResponses],
                    [''],
                    ['=== PRIMARY OUTCOMES ==='],
                    ['Q15 Satisfaction Distribution:'],
                    ['Extremely satisfied (5):', flatTable.filter(r => r.Q15_Satisfaction_Scalar === 5).length],
                    ['Somewhat satisfied (4):', flatTable.filter(r => r.Q15_Satisfaction_Scalar === 4).length],
                    ['Neutral (3):', flatTable.filter(r => r.Q15_Satisfaction_Scalar === 3).length],
                    ['Somewhat dissatisfied (2):', flatTable.filter(r => r.Q15_Satisfaction_Scalar === 2).length],
                    ['Extremely dissatisfied (1):', flatTable.filter(r => r.Q15_Satisfaction_Scalar === 1).length],
                    ['No Response:', flatTable.filter(r => r.Q15_Satisfaction_Scalar === null).length],
                    [''],
                    ['=== KEY INDICATORS ==='],
                    ['High Satisfaction (4-5):', flatTable.filter(r => r.HighSatisfaction === 1).length, `(${Math.round(flatTable.filter(r => r.HighSatisfaction === 1).length / totalResponses * 100)}%)`],
                    ['Low Satisfaction (1-2):', flatTable.filter(r => r.LowSatisfaction === 1).length, `(${Math.round(flatTable.filter(r => r.LowSatisfaction === 1).length / totalResponses * 100)}%)`],
                    ['Has Telehealth:', flatTable.filter(r => r.HasTelehealth === 1).length, `(${Math.round(flatTable.filter(r => r.HasTelehealth === 1).length / totalResponses * 100)}%)`],
                    ['Staff Coverage:', flatTable.filter(r => r.VascularCoverage_Staff === 1).length, `(${Math.round(flatTable.filter(r => r.VascularCoverage_Staff === 1).length / totalResponses * 100)}%)`],
                    ['Private Coverage:', flatTable.filter(r => r.VascularCoverage_Private === 1).length, `(${Math.round(flatTable.filter(r => r.VascularCoverage_Private === 1).length / totalResponses * 100)}%)`],
                    ['Fast Response (‚â§45min):', flatTable.filter(r => r.FastResponse === 1).length, `(${Math.round(flatTable.filter(r => r.FastResponse === 1).length / totalResponses * 100)}%)`],
                    [''],
                    ['=== TRAUMA CENTER BREAKDOWN ==='],
                    ['Level 1:', flatTable.filter(r => r.TraumaCenterLevel === 'Level 1').length],
                    ['Level 2:', flatTable.filter(r => r.TraumaCenterLevel === 'Level 2').length],
                    ['Level 3:', flatTable.filter(r => r.TraumaCenterLevel === 'Level 3').length],
                    ['Unknown/Other:', flatTable.filter(r => !['Level 1', 'Level 2', 'Level 3'].includes(r.TraumaCenterLevel)).length]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryStats);
                XLSX.utils.book_append_sheet(newWb, summaryWs, 'Summary_Statistics');

                updateProgress(90);
                showStatus('Finalizing workbook...', 'processing');

                // Generate and download file
                const wbout = XLSX.write(newWb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                saveAs(blob, `Vascular_Trauma_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`);

                updateProgress(100);
                showStatus(`‚úÖ Analysis workbook generated! ${totalResponses} responses processed with complete statistical framework.`, 'success');

                setTimeout(() => {
                    progressBar.style.display = 'none';
                    updateProgress(0);
                }, 3000);

            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error processing file. Please ensure it is a valid Excel file with survey data.', 'error');
                updateProgress(0);
                progressBar.style.display = 'none';
            } finally {
                generateButton.disabled = false;
            }
        });
    </script>
</body>
</html>